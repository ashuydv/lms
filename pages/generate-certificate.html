<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Generate Certificate</title>
    <link href="https://fonts.googleapis.com/css2?family=Figtree:ital,wght@0,300..900;1,300..900&display=swap"
        rel="stylesheet" />
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.2/css/all.min.css" />
    <script src="https://html2canvas.hertzen.com/dist/html2canvas.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
    <link rel="stylesheet" href="../css/gen-c.css">
</head>

<body class="figtree-400 bg-[#ede9e6]">
    <header class="figtree-400 text-gray-400 sm:block hidden fixed w-full bg-[#13181d] z-50 body-font" id="main-nav">
        <div class="container-fluid mx-auto flex flex-wrap p-5 py-0 flex-col md:flex-row items-center">
            <nav class="flex text-center flex-wrap items-center justify-center w-full pt-3 text-base gap-3">
                <a href="../index.html"
                    class="flex items-center justify-center flex-col gap-1 border-b-4 border-transparent hover:border-white w-[160px] p-4 hover:text-white figtree-400 transition-colors duration-300">
                    <i class="fa-solid fa-house text-2xl"></i>
                    <span class="my-1">Home</span>
                </a>
                <a class="flex items-center justify-center flex-col gap-1 border-b-4 border-transparent hover:border-white
                w-[160px] p-4 hover:text-white figtree-400 transition-colors duration-300">
                    <i class="fa-solid fa-briefcase text-2xl"></i>
                    <span class="my-1">Purchases</span>
                </a>
            </nav>
        </div>
    </header>

    <main id="content" class="min-h-screen">
        <div class="container-fluid mx-auto sm:py-36 sm:px-16 px-0 py-10">
            <div class="p-6 py-10 pt-4 max-w-xl mx-auto">
                <h1 class="text-center mb-4 text-2xl font-semibold text-gray-800">
                    You can generate certificate after 2 months of enrollment in the course.
                </h1>
                <input type="text" placeholder="Enter Your Name" id="nameInput"
                    class="w-full p-3 mb-4 rounded-lg border border-gray-300 text-gray-700 placeholder-gray-400">
                <button
                    class="w-full bg-gray-900 text-white py-3 rounded-lg mb-4 font-medium hover:bg-gray-800 transition-colors duration-300"
                    id="generateCertificate">
                    Generate Certificate
                </button>
                <div class="download-options flex items-center justify-between sm:flex-row flex-col gap-4 mx-auto"
                    id="downloadOptions">
                    <button
                        class="download-btn w-full bg-gray-900 text-white py-3 rounded-lg sm:mb-4 font-medium hover:bg-gray-800 transition-colors duration-300"
                        id="downloadPDF">Download PDF</button>
                </div>
            </div>

            <div id="certificateContainer">
                <div id="certificate">
                    <div class="background"></div>
                    <div class="content">
                        <div class="certificate-logo">
                            <img src="../assets/logo.png" alt="">
                        </div>
                        <h1>Certificate <br> of Completion</h1>
                        <p class="recipient">Proudly Presented to</p>
                        <div class="c-name">
                            <h2 id="certificate-name">
                                Ashutosh Yadav
                            </h2>
                            <hr>
                        </div>
                        <p class="course">Has successfully completed</p>
                        <h3 class="course-name">Speak English With Aleena</h3>
                        <!-- <div class="details">
                            <div>
                                <p class="label">Date</p>
                                <p id="certificate-date"></p>
                            </div>
                            <div>
                                <p class="label">Signature</p>
                                <p>Jane Smith</p>
                            </div>
                        </div> -->
                    </div>
                    <div class="reward-logo">

                    </div>
                    <div class="aleena-signature">
                        <h3>Aleena Rais</h3>
                        <div class="instructor">
                            <p>Aleena Rais</p>
                            <p>Instructor</p>
                        </div>
                    </div>
                    <div class="certificate-id">
                        <a>Certificate ID: 12345678</a>
                    </div>
                </div>
            </div>

            <div id="loader" style="display: none;">Generating...</div>
            <a id="certificateLink" class="hidden" target="_blank"></a>
        </div>
    </main>

    <footer class="bg-[#13181d] text-white p-4 md:hidden fixed bottom-0 w-full">
        <div class="flex justify-evenly gap-4 items-center">
            <a href="../index.html" class="flex flex-col items-center">
                <i class="fa-solid fa-home text-2xl"></i>
                <span class="text-xs mt-1">Home</span>
            </a>
            <a href="#" class="flex flex-col items-center">
                <i class="fa-solid fa-shopping-bag text-2xl"></i>
                <span class="text-xs mt-1">Purchases</span>
            </a>
        </div>
    </footer>

    <footer class="text-white body-font sm:block hidden">
        <div class="bg-[#13181d]">
            <div class="container mx-auto py-4 px-5 flex items-center justify-center flex-wrap flex-col sm:flex-row">
                <p class="text-lg text-center sm:text-left">Â© 2024 Aleena Rais</p>
            </div>
        </div>
    </footer>

    <script>
        document.addEventListener('DOMContentLoaded', function () {
            const generateBtn = document.getElementById('generateCertificate');
            const nameInput = document.getElementById('nameInput');
            const certificateContainer = document.getElementById('certificateContainer');
            const certificateName = document.getElementById("certificate-name");
            const loader = document.getElementById("loader");
            const certificateLink = document.getElementById("certificateLink");

            generateBtn.addEventListener('click', async function () {
                const name = nameInput.value.trim();
                if (name) {
                    showLoader();
                    await generateCertificate(name);
                    hideLoader();
                } else {
                    alert('Please enter a name');
                }
            });

            function showLoader() {
                loader.style.display = 'block';
                certificateContainer.style.display = 'none';
                certificateLink.classList.add('hidden');
            }

            function hideLoader() {
                loader.style.display = 'none';
            }

            async function generateCertificate(name) {
                certificateName.textContent = name;
                certificateContainer.style.display = 'block';

                // Generate PDF
                const pdfBlob = await generatePDF();

                // Save PDF and get unique ID
                const uniqueId = await savePDFLocally(pdfBlob, name);

                // Display link to user
                const certificateUrl = `${window.location.origin}/certificate/${uniqueId}`;
                certificateLink.href = certificateUrl;
                certificateLink.textContent = certificateUrl;
                certificateLink.classList.remove('hidden');
            }

            async function generatePDF() {
                const scale = 5; // Increase resolution
                const canvas = await html2canvas(certificateContainer, {
                    scale: scale,
                    useCORS: true,
                    logging: false
                });

                const imgWidth = 210; // A4 width in mm
                const imgHeight = (canvas.height * imgWidth) / canvas.width;

                const pdf = new jspdf.jsPDF({
                    orientation: imgHeight > imgWidth ? 'portrait' : 'landscape',
                    unit: 'mm',
                    format: [imgWidth, imgHeight]
                });

                pdf.addImage(canvas.toDataURL('image/jpeg', 1.0), 'JPEG', 0, 0, imgWidth, imgHeight);
                return pdf.output('blob');
            }

            async function savePDFLocally(pdfBlob, name) {
                const uniqueId = generateUniqueId();
                const filename = `${uniqueId}_${name}_certificate.pdf`;

                // Convert blob to base64
                const reader = new FileReader();
                reader.readAsDataURL(pdfBlob);

                return new Promise((resolve, reject) => {
                    reader.onloadend = async function () {
                        const base64data = reader.result;

                        try {
                            // Send the data to the server
                            const response = await fetch('/save-certificate', {
                                method: 'POST',
                                headers: {
                                    'Content-Type': 'application/json',
                                },
                                body: JSON.stringify({ uniqueId, name, pdfData: base64data }),
                            });

                            const rawText = await response.text();  // Get raw response text
                            console.log('Raw server response:', rawText);

                            // Parse the raw text as JSON
                            const result = JSON.parse(rawText);
                            console.log('Parsed server response:', result);

                            if (!response.ok) {
                                throw new Error('Failed to save certificate');
                            }

                            resolve(uniqueId);
                        } catch (error) {
                            console.error('Error saving certificate:', error);
                            reject(error);
                        }
                    }
                    reader.onerror = reject;
                });
            }

            function generateUniqueId() {
                return Math.random().toString(36).substr(2, 9);
            }
        });
    </script>
</body>

</html>